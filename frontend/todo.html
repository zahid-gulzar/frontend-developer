<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ToDo App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #161B22; color: #E6EDF3; padding: 20px; font-family: Arial, sans-serif; }
    #allTasks .taskContainer { padding: 10px; margin: 5px 0; border-radius: 8px; background-color: #161B22; display: flex; align-items: center; justify-content: space-between; }
    #allTasks .taskContainer p { margin: 0; flex: 1; padding-left: 10px; }
    .checkbox { width: 20px; height: 20px; }
    .delBtn { cursor: pointer; color: #FF6B6B; }
  </style>
</head>
<body>

<div class="container">
  <h2 id="userName">User</h2>
  <p id="timeDisplay"></p>
  <div class="input-group mb-3">
    <input type="text" class="form-control taskInput" placeholder="Add a task...">
    <button class="btn btn-success" id="button-addon2">Add</button>
  </div>
  <div id="allTasks"></div>
</div>

<script>
const API = 'https://frontend-developer-2r2v.onrender.com/api';
const token = localStorage.getItem('token');
if (!token) window.location.href = 'login.html';

let allTasks = document.querySelector("#allTasks");
let taskInp = document.querySelector(".taskInput");
let addBtn = document.querySelector("#button-addon2");

// Create task DOM
function createTaskElement(task) {
  const taskContainer = document.createElement('div');
  taskContainer.classList.add('taskContainer');
  taskContainer.dataset.id = task._id;
  taskContainer.innerHTML = `
    <input type="checkbox" class="checkbox" ${task.completed ? 'checked' : ''}>
    <p>${task.text}</p>
    <i class="fa-solid fa-trash delBtn"></i>
  `;
  if (task.completed) {
    const text = taskContainer.querySelector('p');
    text.style.textDecoration = 'line-through';
    text.style.color = '#9CA3AF';
    taskContainer.style.backgroundColor = '#0F5132';
    taskContainer.querySelector('.checkbox').style.backgroundColor = '#16A34A';
  }
  return taskContainer;
}

// Load tasks
async function loadTasks() {
  try {
    const res = await fetch(`${API}/tasks`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!res.ok) throw new Error('Failed to fetch tasks');
    const tasks = await res.json();
    allTasks.innerHTML = '';
    tasks.forEach(t => allTasks.appendChild(createTaskElement(t)));
  } catch (err) {
    console.error(err);
  }
}

// Add / Update / Delete tasks
allTasks.addEventListener("click", async (e) => {
  const parentTask = e.target.closest(".taskContainer");
  if (!parentTask) return;
  const id = parentTask.dataset.id;

  // Toggle completed
  if (e.target.classList.contains("checkbox")) {
    const completed = e.target.checked;
    try {
      const res = await fetch(`${API}/tasks/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ completed })
      });
      if (!res.ok) throw new Error('Failed to update task');
      const text = parentTask.querySelector('p');
      if (completed) {
        e.target.style.backgroundColor = "#16A34A";
        parentTask.style.backgroundColor = "#0F5132";
        text.style.textDecoration = "line-through";
        text.style.color = "#9CA3AF";
      } else {
        e.target.style.backgroundColor = "#FFFFFF";
        parentTask.style.backgroundColor = "#161B22";
        text.style.textDecoration = "none";
        text.style.color = "#E6EDF3";
      }
    } catch (err) { console.error(err); }
  }

  // Delete task
  if (e.target.classList.contains("delBtn")) {
    try {
      const res = await fetch(`${API}/tasks/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!res.ok) throw new Error('Failed to delete task');
      parentTask.remove();
    } catch (err) { console.error(err); }
  }
});

// Add new task
addBtn.addEventListener("click", async () => {
  const text = taskInp.value.trim();
  if (!text) return;
  try {
    const res = await fetch(`${API}/tasks`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token 
      },
      body: JSON.stringify({ text })
    });
    if (!res.ok) throw new Error('Failed to add task');
    const task = await res.json();
    allTasks.appendChild(createTaskElement(task));
    taskInp.value = '';
  } catch (err) { console.error(err); }
});

// Display user name
const user = JSON.parse(localStorage.getItem('user'));
if (user?.name) document.getElementById('userName').textContent = user.name;

// Clock
function updateTime() {
  const now = new Date();
  let h = now.getHours();
  const m = now.getMinutes();
  const ampm = h >= 12 ? 'PM' : 'AM';
  h = h % 12 || 12;
  document.getElementById('timeDisplay').textContent = `Time: ${h}:${m < 10 ? '0'+m : m} ${ampm}`;
}
updateTime();
setInterval(updateTime, 1000);

// Initial load
loadTasks();
</script>

<!-- Font Awesome for trash icon -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</body>
</html>
